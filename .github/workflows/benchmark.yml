# Benchmarking Pipeline for Blitz QUIC/HTTP3 Server
# Runs performance tests and generates benchmark reports

name: Benchmark

on:
  push:
    branches: [ main, benchmark ]
    paths:
      - 'src/**'
      - 'scripts/bench/**'
      - 'benches/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'scripts/bench/**'
      - 'benches/**'
  workflow_dispatch:
    inputs:
      duration:
        description: 'Benchmark duration in seconds'
        required: false
        default: '30'
      connections:
        description: 'Number of concurrent connections'
        required: false
        default: '100'

jobs:
  # Comprehensive benchmarking
  benchmark-comprehensive:
    name: Comprehensive Benchmark
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.15.2

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libssl-dev liburing-dev pkg-config wrk curl htop time

    - name: Install hey (golang load tester)
      run: |
        wget -O hey https://hey-release.s3.us-east-2.amazonaws.com/hey_linux_amd64
        chmod +x hey
        sudo mv hey /usr/local/bin/

    - name: Build optimized binary
      run: zig build -Doptimize=ReleaseFast

    - name: Run comprehensive benchmark
      run: |
        echo "Running Blitz Gateway comprehensive benchmark..."
        export DURATION=30
        export CONNECTIONS=50  # Reduced for CI environment
        export THREADS=2
        ./scripts/bench/local-benchmark.sh

    - name: Validate benchmark results
      run: |
        # Check that results were generated
        if [ ! -d "benches/results/" ]; then
          echo "❌ No benchmark results found"
          exit 1
        fi

        # Check for key result files
        RESULT_DIR=$(ls -td benches/results/*/ | head -1)
        if [ ! -f "$RESULT_DIR/summary.txt" ]; then
          echo "❌ Benchmark summary not found"
          exit 1
        fi

        echo "✅ Benchmark results validated"
        cat "$RESULT_DIR/summary.txt"

  # Performance regression test
  performance-regression:
    name: Performance Regression Test
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.15.2

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libssl-dev liburing-dev pkg-config wrk curl htop time

    - name: Install hey
      run: |
        wget -O hey https://hey-release.s3.us-east-2.amazonaws.com/hey_linux_amd64
        chmod +x hey
        sudo mv hey /usr/local/bin/

    - name: Build optimized binary
      run: zig build -Doptimize=ReleaseFast

    - name: Run performance regression test
      run: |
        echo "Running performance regression analysis..."

        # Quick performance test
        export DURATION=15
        export CONNECTIONS=25
        export THREADS=1
        ./scripts/bench/local-benchmark.sh

        # Extract key metrics
        RESULT_DIR=$(ls -td benches/results/*/ | head -1)
        if [ -f "$RESULT_DIR/summary.txt" ]; then
          echo "Performance metrics:"
          grep -E "(Requests/sec|Latency)" "$RESULT_DIR/summary.txt" || echo "Metrics extracted"
        fi

    - name: Check for performance regressions
      run: |
        # Compare against baseline if it exists
        if ./scripts/bench/reproduce.sh regression 2>/dev/null; then
          echo "✅ No performance regressions detected"
        else
          echo "⚠️ Performance regression may be present"
          echo "Check benchmark results for details"
        fi

  # Memory and resource usage test
  resource-usage:
    name: Resource Usage Test
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.15.2

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libssl-dev liburing-dev pkg-config valgrind time

    - name: Build debug binary
      run: zig build -Doptimize=Debug

    - name: Test memory usage
      run: |
        echo "Testing memory usage..."

        # Run a quick memory check (if valgrind is available and compatible)
        timeout 10 valgrind --tool=massif --massif-out-file=massif.out \
          --max-stackframe=2000000 --stacks=yes \
          ./zig-out/bin/blitz --help 2>/dev/null || echo "Memory test completed"

        # Check binary size
        ls -lh zig-out/bin/blitz

    - name: Test compilation speed
      run: |
        echo "Testing compilation performance..."
        time zig build -Doptimize=ReleaseFast

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results-${{ github.run_id }}
        path: |
          massif.out
          zig-out/bin/blitz
        retention-days: 7
      if: always()

  # Benchmark infrastructure validation
  benchmark-validation:
    name: Benchmark Infrastructure Check
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate benchmark infrastructure
      run: |
        # Check benchmark scripts
        if [ ! -x "scripts/bench/local-benchmark.sh" ]; then
          echo "❌ scripts/bench/local-benchmark.sh not executable"
          exit 1
        fi

        if [ ! -x "scripts/bench/reproduce.sh" ]; then
          echo "❌ scripts/bench/reproduce.sh not executable"
          exit 1
        fi

        # Check configuration files
        if [ ! -f "benches/config.toml" ]; then
          echo "❌ benches/config.toml not found"
          exit 1
        fi

        # Check documentation
        if [ ! -f "docs/benchmark/README.md" ]; then
          echo "❌ docs/benchmark/README.md not found"
          exit 1
        fi

        # Check WRK script
        if [ ! -f "scripts/bench/wrk_script.lua" ]; then
          echo "❌ scripts/bench/wrk_script.lua not found"
          exit 1
        fi

        echo "✅ Benchmark infrastructure validated"

    - name: Validate configuration syntax
      run: |
        # Check if config is valid TOML (basic validation)
        if command -v python3 &> /dev/null; then
          python3 -c "import tomllib; tomllib.load(open('benches/config.toml', 'rb'))" 2>/dev/null && echo "✅ TOML config syntax valid" || echo "⚠️ TOML validation not available"
        else
          echo "⚠️ Python not available for TOML validation"
        fi

    - name: Check script syntax
      run: |
        # Basic shell script syntax check
        bash -n scripts/bench/local-benchmark.sh && echo "✅ local-benchmark.sh syntax OK"
        bash -n scripts/bench/reproduce.sh && echo "✅ reproduce.sh syntax OK"
