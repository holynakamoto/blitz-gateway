# Documentation Validation Pipeline
# Runs on documentation changes or weekly schedule

name: Docs

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'README.md'
      - '*.md'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'README.md'
      - '*.md'
  schedule:
    # Weekly validation on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  # Validate documentation structure and links
  validate:
    name: Validate Documentation
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Check documentation structure
      run: |
        echo "üìö Validating documentation structure..."

        # Check for required files
        required_files=("README.md" "docs/CONTRIBUTING.md")
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "‚ùå Missing required file: $file"
            exit 1
          fi
        done

        # Check for broken internal links (basic validation)
        find docs/ README.md -name "*.md" | while read -r file; do
          # Extract relative links and check if targets exist
          grep -o '\[.*\]([^)]*)' "$file" | while read -r link; do
            url=$(echo "$link" | sed 's/.*](\([^)]*\)).*/\1/')
            # Skip external URLs
            if echo "$url" | grep -q '^http'; then
              continue
            fi
            # Remove anchor parts
            path=$(echo "$url" | cut -d'#' -f1)
            if [ -n "$path" ] && [ "$path" != "." ]; then
              if [ ! -f "$(dirname "$file")/$path" ] && [ ! -d "$(dirname "$file")/$path" ]; then
                echo "‚ö†Ô∏è  Potential broken link in $file: $url"
              fi
            fi
          done
        done

        echo "‚úÖ Documentation validation complete"

  # Check repository structure and organization
  structure:
    name: Check Repository Structure
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Validate repository organization
      run: |
        echo "üèóÔ∏è  Validating repository structure..."

        # Check for organized directory structure
        required_dirs=("src" "docs" "tests" "scripts")
        for dir in "${required_dirs[@]}"; do
          if [ ! -d "$dir" ]; then
            echo "‚ùå Missing required directory: $dir"
            exit 1
          fi
        done

        # Check for CI/CD workflows
        if [ ! -d ".github/workflows" ]; then
          echo "‚ùå Missing .github/workflows directory"
          exit 1
        fi

        # Count active workflows
        workflow_count=$(find .github/workflows -name "*.yml" | wc -l)
        echo "üìã Found $workflow_count workflow files"

        # Check for basic project files
        basic_files=("build.zig" "README.md" "LICENSE")
        for file in "${basic_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "‚ùå Missing basic project file: $file"
            exit 1
          fi
        done

        echo "‚úÖ Repository structure validation complete"
