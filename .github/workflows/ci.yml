# GitHub Actions CI/CD Pipeline for Blitz QUIC/HTTP3 Server
# Tests builds, runs unit tests, and validates Docker containers

name: CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'build.zig'
      - 'deps/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'build.zig'
      - 'deps/**'

jobs:
  # Test on multiple platforms
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            zig-target: x86_64-linux
          - os: macos-13
            zig-target: x86_64-macos
          - os: macos-14
            zig-target: aarch64-macos

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.15.2

    - name: Verify Zig installation
      run: zig version

    - name: Install system dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libssl-dev liburing-dev pkg-config

    - name: Build main server
      run: zig build

    - name: Run foundation tests (TLS/HTTP/2)
      run: zig build test-foundation

    - name: Run load balancer tests
      run: zig build test-load-balancer

    - name: Run QUIC tests
      run: zig build test-quic

    - name: Run QUIC frame tests
      run: zig build test-quic-frames

    - name: Run QUIC packet generation tests
      run: zig build test-quic-packet-gen

    - name: Run QUIC packet simple tests
      run: zig build test-quic-packet-simple

    - name: Run transport parameters tests
      run: zig build test-transport-params

    - name: Run all unit tests
      run: zig build test

  # Test QUIC handshake server on Linux (requires io_uring)
  test-quic-handshake:
    name: Test QUIC Handshake Server
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.15.2

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libssl-dev liburing-dev pkg-config

    - name: Build QUIC handshake server
      run: zig build run-quic-handshake --help

    - name: Verify QUIC handshake binary exists
      run: ls -la zig-out/bin/blitz-quic-handshake

  # Test code quality and formatting
  lint:
    name: Code Quality
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.15.2

    - name: Check formatting
      run: zig fmt --check src/ build.zig

    - name: Build with all warnings
      run: zig build -Doptimize=Debug

  # Security audit
  security:
    name: Security Audit
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.15.2

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libssl-dev liburing-dev pkg-config

    - name: Build with security flags
      run: |
        # Build with additional security checks
        zig build -Doptimize=ReleaseSafe

    - name: Verify no vulnerable patterns
      run: |
        # Basic security checks - look for common issues
        if grep -r "unsafe" src/ --include="*.zig" | grep -v "test"; then
          echo "⚠️ Found 'unsafe' usage outside tests"
          exit 1
        fi