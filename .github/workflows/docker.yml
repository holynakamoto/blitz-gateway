# Docker CI/CD Pipeline for Blitz QUIC/HTTP3 Server
# Tests Docker builds and container functionality

name: Docker

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Dockerfile*'
      - 'docker-compose.yml'
      - 'src/**'
      - 'deps/**'
      - '.github/workflows/docker.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'Dockerfile*'
      - 'docker-compose.yml'
      - 'src/**'
      - 'deps/**'

jobs:
  # Test Docker builds
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build production image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        target: prod
        push: false
        tags: blitz-gateway:prod
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build development image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        target: dev
        push: false
        tags: blitz-gateway:dev
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build minimal image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        target: minimal
        push: false
        tags: blitz-gateway:minimal
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # Test Docker Compose functionality
  docker-compose-test:
    name: Docker Compose Test
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Create test certificates
      run: |
        mkdir -p certs
        openssl req -x509 -newkey rsa:2048 \
          -keyout certs/server.key -out certs/server.crt \
          -days 1 -nodes \
          -subj "/C=US/ST=Test/L=Test/O=Blitz/CN=localhost"

    - name: Test docker-compose config
      run: docker-compose config --quiet

    - name: Start services
      run: docker-compose up -d blitz-quic

    - name: Wait for services to be healthy
      run: |
        timeout 60 bash -c 'until docker ps | grep -q "healthy\|running.*blitz-quic"; do sleep 2; done'

    - name: Check container logs
      run: docker-compose logs blitz-quic | head -20

    - name: Verify QUIC port is listening (UDP)
      run: |
        # Give the server a moment to start
        sleep 5
        # Check if UDP port 8443 is open in container
        docker exec blitz-quic-server netstat -uln | grep :8443 || docker exec blitz-quic-server ss -uln | grep :8443

    - name: Test HTTP health check
      run: |
        # Test HTTP endpoint
        timeout 10 curl -f http://localhost:8080/ || echo "HTTP test skipped - server may not be ready"

    - name: Cleanup
      run: docker-compose --profile dev down -v

  # Test QUIC functionality in container
  quic-integration-test:
    name: QUIC Integration Test
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Create test certificates
      run: |
        mkdir -p certs
        openssl req -x509 -newkey rsa:2048 \
          -keyout certs/server.key -out certs/server.crt \
          -days 1 -nodes \
          -subj "/C=US/ST=Test/L=Test/O=Blitz/CN=localhost"

    - name: Start QUIC server in container (dev target)
      run: |
        # Use dev profile for testing (has more tools)
        docker-compose --profile dev up -d blitz-quic-dev
        # Wait for server to start
        sleep 15

    - name: Check QUIC server is running
      run: |
        docker-compose ps
        docker-compose logs blitz-quic | tail -10

    - name: Test QUIC connectivity (if curl supports HTTP/3)
      run: |
        # Check if curl supports HTTP/3
        if curl --version | grep -q "HTTP3\|HTTP/3"; then
          echo "Testing HTTP/3 connectivity..."
          # Test with a short timeout to avoid hanging
          timeout 5 curl --http3-only --insecure -v https://localhost:9443/ 2>&1 | head -10 || echo "QUIC test completed"
        else
          echo "curl doesn't support HTTP/3, skipping QUIC test"
        fi

    - name: Test QUIC scripts
      run: |
        # Test that the Docker scripts work
        if [ -f "scripts/docker/docker-quic.sh" ]; then
          echo "✅ Docker QUIC script exists"
        fi
        if [ -f "scripts/docker/test-quic.sh" ]; then
          echo "✅ QUIC test script exists"
        fi

    - name: Cleanup
      run: docker-compose --profile dev down -v
