# Blitz Benchmark Suite

This directory contains scripts and documentation for benchmarking Blitz against other proxies.

## Quick Start

### Local Development Benchmark

For testing on your local machine:

```bash
# 1. Start Blitz
zig build run

# 2. In another terminal, run local benchmark
./benches/local-benchmark.sh
```

This will run quick tests suitable for development machines and save results to `benches/local-*.txt`.

### Production Benchmark (Bare Metal)

For production-grade benchmarks that match the numbers in `COMPARISON.md`:

1. **Set up hardware** (see `benchmark-machine-spec.md`)
2. **Apply system tuning** (script will do this if run as root)
3. **Run full benchmark**:
   ```bash
   ./benches/reproduce.sh
   ```

Results will be saved to `benches/http1-wrk2.txt` and `benches/latency-wrk.txt`.

## Files

- `reproduce.sh` - Full production benchmark script (bare metal)
- `local-benchmark.sh` - Quick local development benchmark
- `benchmark-machine-spec.md` - Hardware requirements and system tuning
- `COMPARISON.md` - Comparison table vs Nginx/Envoy/Traefik/etc
- `*.txt` - Benchmark results (gitignored, generated by scripts)

## Benchmark Endpoints

Use these endpoints for benchmarking:

- **`/hello`** - Optimized for maximum RPS (fastest path, minimal parsing)
- **`/`** or **`/health`** - Standard health check
- **`/echo/*`** - Echo endpoint (returns request path)

**For maximum RPS, always use `/hello`:**

```bash
wrk2 -t 128 -c 200000 -d 60s -R 12000000 --latency http://$IP/hello
```

## Expected Results

### On Bare Metal (EPYC 9754, 128-core)

- **12-15M RPS** (HTTP/1.1 keep-alive)
- **p99 latency: 60-80 µs**
- **Memory: < 150 MB** at 5M RPS
- **CPU: < 35%** at 5M RPS

### On Local Machine (8-16 cores)

- **1-5M RPS** (depending on hardware)
- **p99 latency: 150-300 µs**
- **Memory: < 200 MB**

## Tools Required

- **wrk2** - Rate-limited RPS testing
  - Install: `git clone https://github.com/giltene/wrk2 && cd wrk2 && make`
  - macOS: `brew install wrk2`
  
- **wrk** - Latency distribution testing
  - Usually comes with wrk2 or install separately
  
- **hey** (optional) - Simple HTTP benchmarking
  - Install: `go install github.com/rakyll/hey@latest`

## System Tuning

For best results, apply system tuning (requires root):

```bash
# High connection limits
sysctl -w net.core.somaxconn=1048576
sysctl -w net.ipv4.tcp_max_syn_backlog=1048576
sysctl -w net.core.netdev_max_backlog=50000

# CPU governor
echo performance | tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor

# File descriptors
ulimit -n 100000
```

The `reproduce.sh` script will apply these automatically if run as root.

## Troubleshooting

**Low RPS (< 1M on good hardware)**
- Check CPU governor: `cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor`
- Verify io_uring: `ls /sys/fs/io_uring`
- Check for thermal throttling: `dmesg | grep -i thermal`
- Ensure system tuning applied (see above)

**Connection errors**
- Increase file descriptor limits: `ulimit -n 100000`
- Check network tuning (somaxconn, backlog)
- Verify firewall rules
- Check for port conflicts

**High latency (> 200 µs)**
- Ensure CPU isolation if possible
- Check for context switching: `vmstat 1`
- Verify no other processes using CPU
- Check network latency: `ping <server_ip>`

## Contributing Benchmark Results

If you run benchmarks on different hardware, please:

1. Document your hardware specs
2. Run `reproduce.sh` and save results
3. Submit a PR with your results

We're building the fastest proxy ever - every benchmark helps!

