name: Build and Release .deb Package

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.6.0)'
        required: true
        default: 'v0.6.0'

jobs:
  build-deb:
    name: Build .deb Package
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Verify submodules
      run: |
        echo "Checking for picotls..."
        if [ ! -f deps/picotls/include/picotls.h ]; then
          echo "Submodules not initialized, initializing..."
          git submodule update --init --recursive || {
            echo "Submodule update failed, checking if picotls exists..."
            if [ -d deps/picotls ]; then
              echo "picotls directory exists, checking contents..."
              find deps/picotls -name "picotls.h" 2>/dev/null | head -5
            fi
            echo "Attempting to initialize submodules again..."
            git submodule sync --recursive
            git submodule update --init --recursive --force
          }
        fi
        if [ ! -f deps/picotls/include/picotls.h ]; then
          echo "ERROR: picotls.h still not found after submodule init"
          echo "Checking deps/picotls structure:"
          ls -la deps/picotls/ 2>/dev/null || echo "deps/picotls doesn't exist"
          find deps -name "picotls.h" 2>/dev/null || echo "No picotls.h found anywhere"
          exit 1
        fi
        echo "✅ picotls.h found"
        ls -la deps/picotls/include/picotls.h
    
    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.15.2
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          liburing-dev \
          libssl-dev \
          pkg-config \
          build-essential
    
    - name: Build optimized binary
      run: |
        zig build run-quic -Doptimize=ReleaseFast
        ls -lah zig-out/bin/blitz-quic
    
    - name: Install nfpm
      run: |
        mkdir -p ~/.local/bin
        curl -sSfL https://github.com/goreleaser/nfpm/releases/latest/download/nfpm_amd64.deb -o /tmp/nfpm.deb
        sudo dpkg -i /tmp/nfpm.deb || sudo apt-get install -yf
        nfpm --version
    
    - name: Extract version from tag
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${{ github.ref_name }}"
        fi
        # Remove 'v' prefix if present
        VERSION=${VERSION#v}
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"
    
    - name: Update nfpm.yaml with version
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        sed -i "s/version: \".*\"/version: \"${VERSION}\"/" packaging/nfpm.yaml
    
    - name: Build .deb package
      run: |
        nfpm pkg --packager deb --target dist/ --config packaging/nfpm.yaml
        ls -lah dist/
    
    - name: Upload .deb as artifact
      uses: actions/upload-artifact@v4
      with:
        name: blitz-gateway-deb
        path: dist/*.deb
        retention-days: 90
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/v')
      with:
        files: dist/*.deb
        body: |
          ## Blitz Gateway ${{ steps.version.outputs.version }}
          
          ### Installation
          
          **One-command install:**
          ```bash
          curl -fsSL https://raw.githubusercontent.com/holynakamoto/blitz-gateway/${{ github.ref_name }}/install.sh | sudo bash
          ```
          
          **Manual install:**
          ```bash
          wget https://github.com/holynakamoto/blitz-gateway/releases/download/${{ github.ref_name }}/blitz-gateway_${{ steps.version.outputs.version }}_amd64.deb
          sudo dpkg -i blitz-gateway_${{ steps.version.outputs.version }}_amd64.deb
          ```
          
          ### Changes
          
          See [CHANGELOG.md](CHANGELOG.md) for detailed changes.
          
          ### Documentation
          
          - [Production Deployment](https://github.com/holynakamoto/blitz-gateway/tree/main/docs/production)
          - [Benchmarking Guide](https://github.com/holynakamoto/blitz-gateway/tree/main/docs/benchmark)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-packagecloud:
    name: Publish to PackageCloud
    runs-on: ubuntu-latest
    needs: build-deb
    if: startsWith(github.ref, 'refs/tags/v') && github.repository == 'holynakamoto/blitz-gateway'
    
    steps:
    - name: Download .deb artifact
      uses: actions/download-artifact@v4
      with:
        name: blitz-gateway-deb
    
    - name: Extract version
      id: version
      run: |
        VERSION="${{ github.ref_name }}"
        VERSION=${VERSION#v}
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
    
    - name: Publish to PackageCloud
      env:
        PACKAGECLOUD_TOKEN: ${{ secrets.PACKAGECLOUD_TOKEN }}
      run: |
        if [ -z "$PACKAGECLOUD_TOKEN" ]; then
          echo "⚠️ PACKAGECLOUD_TOKEN not set, skipping PackageCloud publish"
          echo "Configure at: https://packagecloud.io/api#api_tokens"
          exit 0
        fi
        
        # Upload to PackageCloud
        for DEB in *.deb; do
          echo "Uploading $DEB to PackageCloud..."
          package_cloud push holynakamoto/blitz-gateway/ubuntu/jammy "$DEB" || \
          curl -X POST \
            -H "Content-Type: application/json" \
            -u "$PACKAGECLOUD_TOKEN:" \
            -F "package[distro_version_id]=220" \
            -F "package[package_file]=@$DEB" \
            https://packagecloud.io/api/v1/repos/holynakamoto/blitz-gateway/packages.json || true
        done

